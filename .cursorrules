# 스포츠 분석 프로젝트 - Cursor 규칙

## 언어 및 응답
- 모든 응답은 한국어로 작성
- 코드 주석도 한국어로 작성
- 문서 및 커밋 메시지도 한국어

## 프로젝트 핵심 원칙

### 1. 개발/배포 워크플로우 (절대 준수!)
```
로컬 개발 (Mac) → Git Push → GitHub Actions CI/CD → 원격 서버 자동 배포
```
- ❌ 원격 서버에서 직접 코드 수정 금지
- ❌ GitHub Actions 없이 수동 배포 금지
- ✅ 모든 코드 수정은 로컬에서만
- ✅ Git commit/push로만 배포

### 2. 프로젝트의 진짜 목적: 이변 감지!
- 이 시스템은 "확률 예측"이 아니라 "이변 감지"가 핵심
- 14경기를 모두 맞춰야 당첨 (ALL or NOTHING)
- 13개 맞추고 1개 틀리면 전액 손실
- **이변 감지가 생명줄**
- 전략: 고신뢰 경기 10개 → 단일 베팅, 이변 가능 경기 4개 → 복수 베팅

### 3. 14경기 수집의 중요성 (치명적!)
- ⚠️ 반드시 14경기를 수집해야 함
- 13경기만 있으면 → 베팅 불가능
- 15경기가 있으면 → 잘못된 데이터
- 정확히 14경기만 유효
- 데이터 소스 우선순위: 젠토토 크롤러 → 베트맨 크롤러 → KSPO API

## 코딩 스타일

### Python
- 비동기 함수는 `async def` 사용
- 타입 힌트 필수 (`typing` 모듈 활용)
- 에러 핸들링은 `src/core/error_handling.py`의 데코레이터 사용
- 로깅은 `src/core/logging.py`의 `get_logger()` 사용
- 함수명은 snake_case
- 클래스명은 PascalCase

### 파일 구조
- 서비스 로직: `src/services/`
- API 라우트: `src/api/routes/`
- 데이터 모델: `src/db/models.py`
- 설정: `src/config/`
- 핵심 로직: `src/core/`

### 에러 핸들링
```python
from src.core.error_handling import async_error_handler, retry_async

@async_error_handler(func_name="크롤러", default_return=None)
@retry_async(max_retries=3, delay=1.0)
async def my_function():
    ...
```

### 로깅
```python
from src.core.logging import get_logger

logger = get_logger(__name__)
logger.info("정보 메시지")
logger.error("에러 메시지")
```

## 데이터 수집 규칙

### 우선순위
1. 젠토토 크롤러 v2.0 (정적 크롤링, 투표율 포함)
2. 베트맨 크롤러 (Playwright 기반)
3. KSPO API (fallback, 경기 누락 가능)

### RoundManager 사용
```python
from src.services.round_manager import RoundManager

manager = RoundManager()
# 자동 모드 (권장)
info, games = await manager.get_soccer_wdl_round()
# 특정 소스만
info, games = await manager.get_soccer_wdl_round(source="zentoto")
```

### 데이터 검증
- 항상 `len(games) == 14` 확인
- 14경기 미만일 때 텔레그램 알림 전송
- `src/services/data_validator.py` 활용

## AI 분석 규칙

### AI 앙상블
- 5개 AI 모델 사용: GPT-4, Claude, Gemini, DeepSeek, Kimi
- AI 간 불일치 = 이변 신호 (오류가 아님!)
- 배당 없이 순수 데이터 기반 확률 계산

### 이변 감지 로직
- 확률 분포 애매함 (1위-2위 차이 < 15%)
- AI 신뢰도 낮음 (confidence < 50%)
- AI 모델 간 불일치 (agreement < 60%)
- EnhancedUpsetDetector 활용 (v4.0.0)

## 텔레그램 알림 형식

### 필수 포함 사항
- 회차 번호
- 14경기 전체 예측
- 단식 정답 (1:1 2:1 3:X ...)
- 복수 4경기 (총 16조합)
- 이변 위험도 표시 (🔴HIGH / 🟡MED / 🟢LOW)

## 테스트 규칙

### 필수 테스트
- 14경기 수집 확인
- 데이터 검증 (`test_data_validation.py`)
- 통합 테스트 (`test_round_manager_integration.py`)

### 테스트 모드
```bash
# 테스트 모드 (전송 안함)
python3 auto_sports_notifier.py --test
python3 auto_sports_notifier.py --soccer --test
```

## Git 커밋 규칙

### 커밋 메시지 형식
```
feat: 기능 추가
fix: 버그 수정
docs: 문서 수정
refactor: 리팩토링
test: 테스트 추가

예시:
feat: 젠토토 크롤러 투표율 추출 기능 추가

- 정적 크롤링으로 전환 (requests + BeautifulSoup)
- home_vote, draw_vote, away_vote 필드 추가
- 팀명 파싱 로직 개선
```

## 절대 금지 사항

1. ❌ 배당률 기반 확률 계산
2. ❌ 14경기 미만 수집
3. ❌ 복수 베팅 미고려
4. ❌ KSPO API만 사용 (경기 누락 가능)
5. ❌ 원격 서버에서 직접 코드 수정
6. ❌ 이변 감지 로직 약화
7. ❌ AI 불일치를 오류로 처리

## 필수 문서

- `CLAUDE.md` - 프로젝트 핵심 가이드 (필독!)
- `DEBUG_GUIDE.md` - 디버깅 가이드
- `docs/DATA_VALIDATION.md` - 데이터 검증 가이드

## 서버 정보

- 프로덕션 서버: 141.164.55.245 (한국 서울)
- 프로젝트 경로: `/opt/sports-analysis`
- Docker 컨테이너: `sports_analysis`
- 포트: 5001

## 디버깅

### 통합 디버깅 도구
```bash
# 전체 코드 디버깅
python debug_all.py

# 빠른 디버깅
./quick_debug.sh
```

### 로깅 레벨
- 개발: DEBUG
- 프로덕션: INFO

## 코드 작성 시 체크리스트

- [ ] 14경기 수집 확인 (`len(games) == 14`)
- [ ] 이변 감지 로직 적용
- [ ] 에러 핸들링 데코레이터 사용
- [ ] 타입 힌트 추가
- [ ] 로깅 추가
- [ ] 테스트 모드로 검증
- [ ] Git 커밋 전 로컬 테스트

## 참고 파일

- `CLAUDE.md` - 상세 가이드 (2200+ 라인)
- `src/core/error_handling.py` - 에러 핸들링 표준
- `src/core/logging.py` - 로깅 표준
- `src/config/constants.py` - 상수 정의
- `src/services/round_manager.py` - 데이터 수집 매니저

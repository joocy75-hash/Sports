# GitHub Actions: Group B (Sports Analysis) Deployment
# Target Server: 141.164.55.245 (Seoul)
# Path: /root/service_b

name: Deploy Group B (Sports Analysis)

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'auto_sports_notifier.py'
      - 'deployment/hetzner/group_b_automation/**'
      - '.github/workflows/deploy-group-b.yml'
  workflow_dispatch:

env:
  SERVER_IP: 141.164.55.245
  SERVER_USER: root
  REMOTE_DIR: /root/service_b

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Seoul Server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      # 1. Docker Compose íŒŒì¼ ì „ì†¡
      - name: Copy Docker Compose
        run: |
          scp deployment/hetzner/group_b_automation/docker-compose.yml ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${{ env.REMOTE_DIR }}/docker-compose.yml

      # 2. Backend ì½”ë“œ ë™ê¸°í™”
      - name: Sync Backend Code
        run: |
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.state' \
            --exclude='logs' \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='.git' \
            ./src \
            ./auto_sports_notifier.py \
            ./auto_telegram_bot.py \
            ./basketball_w5l_analyzer.py \
            ./basketball_w5l_notifier.py \
            ./collect_and_notify.py \
            ./requirements.txt \
            ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${{ env.REMOTE_DIR }}/sports_analysis/

      # 3. Frontend ì½”ë“œ ë™ê¸°í™”
      - name: Sync Frontend Code
        run: |
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.git' \
            ./frontend/ \
            ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${{ env.REMOTE_DIR }}/frontend/

      # 4. ì„œë¹„ìŠ¤ ì¬ë°°í¬ (Build & Up)
      - name: Deploy Services
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "cd ${{ env.REMOTE_DIR }} && docker compose up -d --build --remove-orphans"

      # 5. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
      - name: Prune Docker Images
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "docker image prune -f"

      # 6. ìƒíƒœ í™•ì¸
      - name: Check Health
        run: |
          sleep 10
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "cd ${{ env.REMOTE_DIR }} && docker compose ps"

      # 7. ì„±ê³µ ì•Œë¦¼
      - name: Notify Telegram (Success)
        if: success()
        run: |
          COMMIT_SHORT="${GITHUB_SHA:0:7}"
          DEPLOY_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âœ… *ìŠ¤í¬ì¸  ë¶„ì„(Group B) ë°°í¬ ì„±ê³µ*%0A%0AğŸ“¦ ì»¤ë°‹: \`${COMMIT_SHORT}\`%0AğŸŒ ì„œë²„: Seoul (${{ env.SERVER_IP }})%0AğŸ• ì‹œê°„: ${DEPLOY_TIME}"

      # 8. ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify Telegram (Failure)
        if: failure()
        run: |
          COMMIT_SHORT="${GITHUB_SHA:0:7}"
          LOG_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âŒ *ìŠ¤í¬ì¸  ë¶„ì„(Group B) ë°°í¬ ì‹¤íŒ¨*%0A%0AğŸ“¦ ì»¤ë°‹: \`${COMMIT_SHORT}\`%0AğŸ”— [ë¡œê·¸ í™•ì¸](${LOG_URL})"

# GitHub Actions: Group B (Sports Analysis) Deployment
# Target Server: 141.164.55.245 (Seoul)
# Path: /opt/sports-analysis
# Strategy: Git pull + Docker rebuild

name: Deploy Group B (Sports Analysis)

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'frontend/**'
      - 'auto_sports_notifier.py'
      - 'config/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'requirements.txt'
      - '.github/workflows/deploy-group-b.yml'
  workflow_dispatch:

env:
  SERVER_IP: 141.164.55.245
  SERVER_USER: root
  REMOTE_DIR: /opt/sports-analysis

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Seoul Server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      # 1. Git pullë¡œ ì½”ë“œ ì—…ë°ì´íŠ¸
      - name: Pull Latest Code
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "cd ${{ env.REMOTE_DIR }} && git fetch origin main && git reset --hard origin/main"

      # 2. Docker ì´ë¯¸ì§€ ì¬ë¹Œë“œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Rebuild and Restart Services
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "cd ${{ env.REMOTE_DIR }} && docker compose down && docker compose up -d --build"

      # 3. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
      - name: Prune Docker Images
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "docker image prune -f"

      # 4. í—¬ìŠ¤ ì²´í¬
      - name: Check Health
        run: |
          sleep 15
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "docker ps | grep sports_analysis"

      # 5. ì„±ê³µ ì•Œë¦¼
      - name: Notify Telegram (Success)
        if: success()
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          DEPLOY_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âœ… *ìŠ¤í¬ì¸  ë¶„ì„(Group B) ë°°í¬ ì„±ê³µ*%0A%0AğŸ“¦ ì»¤ë°‹: \`${COMMIT_SHORT}\`%0AğŸŒ ì„œë²„: Seoul (${{ env.SERVER_IP }})%0AğŸ• ì‹œê°„: ${DEPLOY_TIME}"

      # 6. ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify Telegram (Failure)
        if: failure()
        env:
          COMMIT_SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          LOG_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âŒ *ìŠ¤í¬ì¸  ë¶„ì„(Group B) ë°°í¬ ì‹¤íŒ¨*%0A%0AğŸ“¦ ì»¤ë°‹: \`${COMMIT_SHORT}\`%0AğŸ”— [ë¡œê·¸ í™•ì¸](${LOG_URL})"

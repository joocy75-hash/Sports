# GitHub Actions: ìŠ¤í¬ì¸  ë¶„ì„ ì‹œìŠ¤í…œ ìë™ ë°°í¬
# main ë¸Œëœì¹˜ push ì‹œ Hetzner ì„œë²„ì— ìë™ ë°°í¬

name: Deploy Sports Analysis

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

  # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'ë°°í¬ ìœ í˜•'
        required: true
        default: 'update'
        type: choice
        options:
          - update
          - restart

env:
  SERVER_IP: 5.161.112.248
  SERVER_USER: root
  REMOTE_DIR: /root/sports-analysis

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Hetzner

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. SSH í‚¤ ì„¤ì •
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
        env:
          SSH_KEY: ${{ secrets.HETZNER_SSH_KEY }}

      # 3. ì½”ë“œ ë™ê¸°í™” (rsync)
      - name: Sync code to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.state' \
            --exclude='logs' \
            --exclude='*.log' \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='frontend' \
            --exclude='deployment' \
            --exclude='deepseek_env' \
            --exclude='.DS_Store' \
            --exclude='Users' \
            --exclude='archive' \
            ./ "$SERVER_USER@$SERVER_IP:$REMOTE_DIR/"

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Build and restart service
        run: |
          ssh "$SERVER_USER@$SERVER_IP" << 'EOF'
            cd /root/sports-analysis

            # ì´ë¯¸ì§€ ë¹Œë“œ
            docker compose build

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            docker compose down || true
            docker compose up -d

            # ìƒíƒœ í™•ì¸
            sleep 5
            docker compose ps
          EOF

      # 5. í—¬ìŠ¤ì²´í¬
      - name: Health check
        run: |
          sleep 10
          ssh "$SERVER_USER@$SERVER_IP" "docker compose -f /root/sports-analysis/docker-compose.yml ps --format json" | jq -e '.[0].State == "running"'

      # 6. í…”ë ˆê·¸ë¨ ì•Œë¦¼ (ì„±ê³µ)
      - name: Notify Telegram (Success)
        if: success()
        run: |
          COMMIT_SHORT="${GITHUB_SHA:0:7}"
          DEPLOY_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT}" \
            -d parse_mode="Markdown" \
            -d text="âœ… *ìŠ¤í¬ì¸  ë¶„ì„ ë°°í¬ ì„±ê³µ*

ğŸ“¦ ì»¤ë°‹: \`${COMMIT_SHORT}\`
ğŸ‘¤ ë°°í¬ì: ${DEPLOYER}
ğŸ• ì‹œê°„: ${DEPLOY_TIME}"
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEPLOYER: ${{ github.actor }}

      # 7. í…”ë ˆê·¸ë¨ ì•Œë¦¼ (ì‹¤íŒ¨)
      - name: Notify Telegram (Failure)
        if: failure()
        run: |
          COMMIT_SHORT="${GITHUB_SHA:0:7}"
          LOG_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT}" \
            -d parse_mode="Markdown" \
            -d text="âŒ *ìŠ¤í¬ì¸  ë¶„ì„ ë°°í¬ ì‹¤íŒ¨*

ğŸ“¦ ì»¤ë°‹: \`${COMMIT_SHORT}\`
ğŸ‘¤ ë°°í¬ì: ${DEPLOYER}
ğŸ”— [ë¡œê·¸ í™•ì¸](${LOG_URL})"
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEPLOYER: ${{ github.actor }}

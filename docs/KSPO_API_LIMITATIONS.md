# KSPO API 한계점 분석 및 베트맨 크롤러 필요성

> **이 문서는 KSPO 공공데이터 API의 구조적 한계와 왜 베트맨 크롤러가 필수인지 설명합니다.**

---

## 1. 핵심 요약

```
⚠️ KSPO 공공데이터 API는 "발매 회차별 14경기"를 위한 API가 아닙니다!

- 이 API는 경기 결과 아카이브 용도로 설계됨
- 회차 정보(turn_no)가 제공되지 않음 (모두 NULL)
- row_num은 경기 번호(1~14)가 아닌 전체 DB 시퀀스 번호
- 따라서 베트맨 크롤러가 필수
```

---

## 2. 베트맨 시스템 vs KSPO API 비교

### 2.1 목적의 차이

| 항목 | 베트맨 웹사이트 | KSPO 공공데이터 API |
|------|---------------|-------------------|
| **설계 목적** | 실시간 발매 정보 제공 | 역사적 데이터 아카이브 |
| **주요 사용자** | 베팅 고객 | 데이터 분석가, 연구자 |
| **데이터 특성** | 현재 발매 중인 14경기 | 전체 경기 기록 (수백~수천 개) |
| **업데이트 주기** | 실시간 | 배치 처리 (지연 있음) |

### 2.2 데이터 구조 차이

| 필드 | 베트맨 웹사이트 | KSPO API |
|------|---------------|----------|
| **회차 번호** | 정확한 값 (예: 152회차) | **NULL (미제공)** |
| **경기 번호** | 1~14 순서 보장 | **DB 시퀀스 (405, 406...)** |
| **경기 수** | 정확히 14경기 | **불규칙 (12~19경기)** |
| **날짜 그룹핑** | 회차 단위 | 날짜 단위만 가능 |

---

## 3. KSPO API 실제 응답 분석

### 3.1 API 호출 결과 (2025-12-25 기준)

```
총 경기 수: 703개

상품별 분류:
- 프로토: 305경기
- 토토/프로토: 231경기
- unknown: 167경기
```

### 3.2 축구 토토/프로토 상세 분석

```
=== 12/27 날짜 데이터 ===
경기 수: 12경기 (14경기가 아님!)
turn_no: 모두 NULL
row_nums: [405, 406, 408, 409, 410, 411, 412, 413, 414, 415, 418, 439]
         ↑ 이건 경기 번호가 아닌 전체 DB 인덱스!

샘플 데이터:
  row_num=405: 스토크시티 vs 프레스턴노스엔드
  row_num=406: 미들즈브러 vs 블랙번로버스

=== 12/28 날짜 데이터 ===
경기 수: 7경기 (같은 회차인데 별도 날짜로 분리됨)
turn_no: 모두 NULL
row_nums: [442, 443, 444, 445, 447, 449, 473]

샘플 데이터:
  row_num=442: 번리 vs 에버턴
  row_num=443: 웨스트햄유나이티드 vs 풀럼
```

### 3.3 베트맨 웹사이트 실제 데이터 (152회차)

```
경기 수: 정확히 14경기
회차: 152회차 (명확히 표시)
경기 번호: 1~14 순서대로

1경기: 레스터C vs 왓포드 (12/25 00:00)
2경기: 노리치C vs 찰턴 (12/25 00:00)
...
10경기: 아스널 vs 브라이턴 (12/28 00:00)
...
14경기: 첼시 vs A빌라 (12/28 02:30)
```

---

## 4. 왜 이런 차이가 발생하는가?

### 4.1 시스템 아키텍처 추정

```
┌─────────────────────────────────────────────────────────────────┐
│                      베트맨 내부 시스템                           │
│                                                                  │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐  │
│   │  회차 관리   │ ───► │  발매 시스템  │ ───► │  웹사이트    │  │
│   │     DB      │      │              │      │  (정확한 정보) │  │
│   └──────────────┘      └──────────────┘      └──────────────┘  │
│          │                                                       │
│          │ 회차별 14경기 정보                                     │
│          │ (정확한 경기 번호 1~14)                                │
│          │ (회차 번호 152)                                        │
│          │                                                       │
│          ▼                                                       │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │              공공데이터 포털 연동 모듈                      │  │
│   │                                                          │  │
│   │  ⚠️ 문제: 회차 정보가 연동되지 않음!                       │  │
│   │  - turn_no 필드가 NULL로 전송                             │  │
│   │  - row_num이 원본 경기 번호가 아닌 시퀀스로 변환            │  │
│   │  - 날짜별로만 데이터 제공, 회차별 그룹핑 없음               │  │
│   │                                                          │  │
│   └──────────────────────────────────────────────────────────┘  │
│          │                                                       │
│          ▼                                                       │
│   ┌──────────────┐                                              │
│   │  KSPO API   │ ◄── 회차 정보 없이 경기 데이터만 제공          │
│   │ (공공데이터) │      row_num = DB 시퀀스 번호                  │
│   └──────────────┘      turn_no = NULL                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 추정되는 원인

1. **데이터 연동 범위 제한**
   - 공공데이터 포털은 "경기 정보"만 제공하도록 설계
   - "발매 회차 정보"는 사업적으로 민감한 데이터로 판단하여 미제공

2. **DB 스키마 차이**
   - 베트맨 내부: `회차 테이블` ↔ `경기 테이블` 관계
   - 공공데이터: `경기 테이블`만 독립적으로 제공
   - 관계 정보(FK)가 연동되지 않아 turn_no가 NULL

3. **row_num 필드의 의미 변경**
   - 베트맨 내부: 회차 내 경기 순번 (1~14)
   - 공공데이터: 전체 테이블의 PK 또는 시퀀스 번호

---

## 5. KSPO API 사용 시 발생하는 문제

### 5.1 경기 번호 불일치

```
베트맨 웹사이트 (정확):
  1번 경기: 레스터C vs 왓포드
  2번 경기: 노리치C vs 찰턴
  ...

KSPO API (부정확):
  row_num=405: 스토크시티 vs 프레스턴  ← 1번이 아님!
  row_num=406: 미들즈브러 vs 블랙번    ← 2번이 아님!
  ...
```

### 5.2 경기 수 불일치

```
필요한 데이터: 14경기 (고정)

KSPO API 응답:
  12/27: 12경기
  12/28: 7경기
  합계: 19경기 (중복 또는 다른 회차 포함)

→ 어떤 14경기가 현재 발매 중인 회차인지 알 수 없음
```

### 5.3 회차 구분 불가

```
문제 상황:
  - 12/27에 152회차 경기 9개 + 153회차 경기 3개 있을 수 있음
  - turn_no가 NULL이므로 구분 불가
  - 날짜만으로는 회차 경계를 알 수 없음
```

### 5.4 날짜 경계 문제

```
152회차 실제 구성:
  - 12/25~12/27 경기: 9경기
  - 12/28 경기: 5경기
  - 총: 14경기

KSPO API로 조회 시:
  - 12/27 조회: 12경기 (다른 회차 포함 가능)
  - 12/28 조회: 7경기 (다른 회차 포함 가능)
  - 어떤 경기가 152회차인지 알 수 없음
```

---

## 6. 해결책: 베트맨 크롤러

### 6.1 왜 크롤러가 필수인가?

```
베트맨 웹사이트만이 유일하게:
1. 정확한 회차 번호 제공 (152회차)
2. 정확한 경기 순번 제공 (1~14번)
3. 회차별 14경기 그룹핑 제공
4. 실시간 발매 정보 제공
```

### 6.2 현재 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                      RoundManager                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   1순위: 베트맨 크롤러 (BetmanCrawler)                        │
│   ├── ✅ 정확한 14경기 수집 보장                              │
│   ├── ✅ 정확한 회차 번호 (152회차)                           │
│   ├── ✅ 정확한 경기 번호 (1~14)                              │
│   └── ✅ 베트맨 웹사이트와 100% 일치                          │
│                                                              │
│   2순위: KSPO API (Fallback용)                               │
│   ├── ⚠️ 경기 누락 가능 (12~14경기 불규칙)                   │
│   ├── ⚠️ row_num 불일치 (DB 시퀀스 번호)                     │
│   ├── ⚠️ turn_no가 NULL (회차 추정 필요)                     │
│   └── ⚠️ 날짜 경계로 회차 구분 불가                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. KSPO API를 완전히 버리지 않는 이유

### 7.1 Fallback 용도

```python
# 크롤러 실패 시 차선책으로 사용
try:
    info, games = await crawler.get_soccer_wdl_games()
except Exception:
    # API로 fallback (불완전하지만 없는 것보다 나음)
    info, games = await api.get_matches()
```

### 7.2 경기 결과 확인

```
KSPO API는 경기 결과(match_end_val)를 제공:
  - "1:2" (홈 1골, 원정 2골)
  - "0:0"
  - "취소"

→ 경기 종료 후 결과 확인 용도로 유용
```

### 7.3 과거 데이터 분석

```
KSPO API는 과거 경기 아카이브:
  - 수백 개의 과거 경기 데이터
  - 팀별 성적 분석에 활용 가능
  - AI 학습 데이터로 활용 가능
```

---

## 8. 향후 개선 가능성

### 8.1 KSPO API 개선 요청

공공데이터포털에 다음 사항을 요청할 수 있음:

1. **turn_no 필드 제공**
   - 회차 번호가 NULL이 아닌 실제 값으로 제공

2. **경기 순번 필드 추가**
   - 회차 내 경기 순번 (1~14) 별도 필드 제공

3. **회차별 조회 파라미터 추가**
   - `turn_no=152` 같은 필터링 지원

### 8.2 베트맨 공식 API

- 베트맨에서 공식 API를 제공할 경우 크롤러 대체 가능
- 현재는 공식 API 없음 (웹사이트만 제공)

---

## 9. 요약

| 질문 | 답변 |
|------|------|
| KSPO API가 베트맨 데이터를 제공하는가? | 부분적으로만 (경기 정보만) |
| 회차 정보를 받을 수 있는가? | **아니오 (turn_no = NULL)** |
| 경기 번호(1~14)를 받을 수 있는가? | **아니오 (row_num = DB 시퀀스)** |
| 정확한 14경기를 받을 수 있는가? | **아니오 (날짜별 불규칙)** |
| 베트맨 크롤러가 필수인가? | **예** |

---

## 10. 참고: API 문서

- **KSPO API**: [공공데이터포털 - 체육진흥투표권 발매대상 경기정보](https://www.data.go.kr/)
- **베트맨**: [https://www.betman.co.kr](https://www.betman.co.kr)

---

**버전**: 1.0.0
**최종 업데이트**: 2025-12-25
**작성**: AI Assistant

> 이 문서를 통해 KSPO API의 구조적 한계를 이해하고,
> 왜 베트맨 크롤러가 필수인지 명확히 알 수 있습니다.
